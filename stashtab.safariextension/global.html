<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <script type="text/javascript" charset="utf-8">
      var WINDOWS_KEY = 'windows';
      var WINDOW_PREFIX = 'window:';

      var COMMANDS = {
        'stash-all-tabs': stashAllTabs,
        'open-overview': openOverview
      }

      function openOverview() {
        var newTab = safari.application.activeBrowserWindow.activeTab;
        newTab.url = safari.extension.baseURI + "overview.html"
      }

      function restoreWindow(window) {
        window.tabs.forEach(restoreTab);
      }

      function restoreTab(tab) {
        var newTab = safari.application.activeBrowserWindow.openTab();
        newTab.url = tab.url;
      }

      function stashAllTabs() {
        var activeWindow = safari.application.activeBrowserWindow;
        var tabs = activeWindow.tabs.reverse().map(tabData);

        var window = {
          id: generateId(),
          tabs: tabs,
          createdAt: new Date()
        };

        localStorage[WINDOW_PREFIX+window.id] = JSON.stringify(window);
        addWindowToWindowList(window);
      }

      function addWindowToWindowList(window) {
        var list = JSON.parse(localStorage[WINDOWS_KEY] || '[]');
        list.unshift(window.id);
        localStorage[WINDOWS_KEY] = JSON.stringify(list);
      }

      function tabData(tab) {
        return {id: generateId(), title: tab.title, url: tab.url};
      }

      function generateId() {
          return Math.random().toString(36).substring(2, 15) +
              Math.random().toString(36).substring(2, 15);
      }

      safari.application.addEventListener("command", function(event) {
        var fn = COMMANDS[event.command];
        fn && fn(event);
      }, false);

      safari.application.addEventListener("validate", function(event) {
        var toolbarItem = event.target;
        if (!toolbarItem.browserWindow) { return; }

        var canStash = toolbarItem.browserWindow.tabs.some(function(tab) {
          return !!tab.url;
        });

        if (canStash) {
          toolbarItem.command = 'stash-all-tabs';
          toolbarItem.image = safari.extension.baseURI + 'toolbar-in.png';
          toolbarItem.tooltip = 'Stash all tabs';
        } else {
          toolbarItem.command = 'open-overview';
          toolbarItem.image = safari.extension.baseURI + 'toolbar-out.png';
          toolbarItem.tooltip = 'Open stash overview';
        }
      }, false);

    </script>
  </head>

  <body></body>
</html>
